using System;
using System.IO;
using System.Linq;
using System.Windows;
using Microsoft.Win32;
using DataLayer;
using DataLayer.Models;

public partial class MainWindow : Window
{
    private AppDbContext _db;
    
    public MainWindow()
    {
        InitializeComponent();
        
        // Подключаемся к БД
        _db = new AppDbContext();
        
        // Загружаем фильмы из БД
        LoadFilms();
    }
    
    private void LoadFilms()
    {
        try
        {
            // Берем все фильмы из таблицы Films
            var films = _db.Films.ToList();
            comboFilms.ItemsSource = films;
            
            if (films.Any())
                comboFilms.SelectedIndex = 0;
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка загрузки фильмов: {ex.Message}");
        }
    }
    
    private void AddFrame_Click(object sender, RoutedEventArgs e)
    {
        // 1. Проверяем выбран ли фильм
        if (comboFilms.SelectedItem == null)
        {
            MessageBox.Show("Выберите фильм!");
            return;
        }
        
        // 2. Открываем диалог выбора файла
        var dialog = new OpenFileDialog
        {
            Filter = "Картинки|*.jpg;*.png;*.bmp|Все файлы|*.*"
        };
        
        if (dialog.ShowDialog() == true)
        {
            string filePath = dialog.FileName;
            
            // 3. Проверяем размер (не более 2 МБ)
            long fileSize = new FileInfo(filePath).Length;
            if (fileSize > 2 * 1024 * 1024)
            {
                MessageBox.Show("Слишком большой файл! Макс. 2 МБ");
                return;
            }
            
            // 4. Копируем в папку images рядом с программой
            string exeDir = AppDomain.CurrentDomain.BaseDirectory;
            string imagesDir = Path.Combine(exeDir, "images");
            
            if (!Directory.Exists(imagesDir))
                Directory.CreateDirectory(imagesDir);
            
            string fileName = Path.GetFileName(filePath);
            string destPath = Path.Combine(imagesDir, fileName);
            
            try
            {
                File.Copy(filePath, destPath, true);
                MessageBox.Show($"Файл сохранен в:\n{destPath}");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка копирования: {ex.Message}");
            }
        }
    }
}
